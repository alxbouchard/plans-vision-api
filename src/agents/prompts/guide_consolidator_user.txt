Produce a final visual guide from the validated data.

PROVISIONAL GUIDE:
{provisional_guide}

STABILITY REPORT:
{stability_report}

MINIMUM STABLE RATIO REQUIRED: {min_stable_ratio}%

RULE KIND CONTRACT (STRICT, CLOSED LIST):
You MUST set payload.kind to ONE of these exact values only:
token_detector
pairing
exclude

Any other payload.kind value is INVALID and MUST NOT be used.

If a rule cannot be represented using ONLY these kinds:
Set “payload”: null for that rule
Do NOT invent a new kind
Do NOT rename kinds
Do NOT output approximate kinds

Explicitly forbidden payload.kind examples:
layout_zone_template
fill_detector
lineweight_classifier
arc_opening_detector
symbol_detector
callout_detector
composite_extraction
markup_detector
table_detector
legend_row_pair_extractor
and ANY other value not in the allowed list

If you are unsure which kind applies:
Set payload = null
Do NOT guess

You MUST respond with a valid JSON object following this exact structure:

{{
  "guide_generated": true,
  "stable_rules": [
    {{
      "id": "RULE_001",
      "description": "Clear rule description",
      "applies_when": "When/where this rule applies",
      "evidence": "Evidence from validated pages",
      "stability_score": 0.95,
      "payload": {{
        "kind": "token_detector",
        "token_type": "room_name",
        "detector": "regex",
        "pattern": "[A-Z]{{2,}}"
      }}
    }}
  ],
  "partial_observations": [
    "Observation noted but not validated enough to be a rule"
  ],
  "excluded_rules": [
    {{
      "id": "RULE_003",
      "reason": "Contradicted on page 3"
    }}
  ],
  "limitations": [
    "Known limitation of this guide"
  ],
  "confidence_level": "high | medium | low",
  "rejection_reason": null
}}

═══════════════════════════════════════════════════════════════════════════════
PHASE 3.4 — SINGLE PAGE ROOM EXTRACTION (MANDATORY)
═══════════════════════════════════════════════════════════════════════════════

CRITICAL: A single page with visible room labels MUST produce a usable guide.
Multi-page validation increases confidence but is NOT required.

RULE: If the provisional guide contains observations about room names, room numbers, or spatial relationships between them, you MUST include ALL 3 payloads below in stable_rules:

1. token_detector for room_name (REQUIRED):
{{
"kind": "token_detector",
"token_type": "room_name",
"detector": "regex",
"pattern": "[A-Z]{{2,}}",
"min_len": 2
}}

2. token_detector for room_number (REQUIRED):
{{
"kind": "token_detector",
"token_type": "room_number",
"detector": "regex",
"pattern": "\\d{{2,4}}",
"must_be_boxed": false
}}

3. pairing for room_name ↔ room_number (REQUIRED):
{{
"kind": "pairing",
"name_token": "room_name",
"number_token": "room_number",
"relation": "below",
"max_distance_px": 100
}}

SINGLE PAGE RULES (Phase 3.4):
- For room label payloads, stability_score >= 0.5 is ACCEPTABLE
- Do NOT exclude room_number or pairing just because stability_score < 0.8
- The 0.8 threshold applies to other rules, NOT to these 3 mandatory payloads
- If pages_testable = 1, this is valid — single page is sufficient
- Adapt pattern and relation based on actual observations (do not blindly copy defaults)

FORBIDDEN BEHAVIORS:
- payload=null for room label rules when observations exist
- Excluding room_number because "only observed on one page"
- Excluding pairing because "insufficient cross-page validation"
- Setting guide_generated=false when room labels are visible and 3 payloads can be derived

MISSING PAYLOADS = FAILURE:
If room labels are visible but you cannot derive all 3 payloads:
- Set guide_generated=false
- Set rejection_reason to explain WHICH payload is missing and WHY
- Log this as a failure, not a partial success

WHY: Without these 3 payloads, rooms_emitted=0 and Phase 3.4 extraction fails.

Optional exclude (to filter out global annotations):
{{
"kind": "exclude",
"pattern": "^(PLAN|PAGE|REV|DATE|SCALE).*",
"detector": "regex"
}}

CRITICAL RULES:
	1.	If stable rules ratio < {min_stable_ratio}%, set guide_generated=false
	2.	If guide_generated=false, stable_rules MUST be empty and rejection_reason MUST explain why
	3.	ONLY include rules marked as STABLE in stable_rules
	4.	NEVER include unstable or contradicted rules in stable_rules
	5.	All excluded rules must have a clear reason
	6.	Be explicit about limitations
	7.	Each stable_rule SHOULD have a payload only when representable with allowed kinds
	8.	Never output payload with invalid kind. If you cannot express it, set payload=null

REFUSAL CASE:
If you cannot generate a guide, respond with:

{{
  "guide_generated": false,
  "stable_rules": [],
  "partial_observations": [...],
  "excluded_rules": [...],
  "limitations": [],
  "confidence_level": "low",
  "rejection_reason": "Specific explanation of why guide cannot be generated and what is needed"
}}

Respond ONLY with the JSON object, no other text.

