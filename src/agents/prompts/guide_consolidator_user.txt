Produce a final visual guide from the validated data.

PROVISIONAL GUIDE:
{provisional_guide}

STABILITY REPORT:
{stability_report}

MINIMUM STABLE RATIO REQUIRED: {min_stable_ratio}%

You MUST respond with a valid JSON object following this exact structure:

```json
{{
  "guide_generated": true,
  "stable_rules": [
    {{
      "id": "RULE_001",
      "description": "Clear rule description",
      "applies_when": "When/where this rule applies",
      "evidence": "Evidence from validated pages",
      "stability_score": 0.95,
      "payload": {{
        "kind": "token_detector",
        "token_type": "room_name",
        "detector": "regex",
        "pattern": "[A-Z]{{2,}}"
      }}
    }}
  ],
  "partial_observations": [
    "Observation noted but not validated enough to be a rule"
  ],
  "excluded_rules": [
    {{
      "id": "RULE_003",
      "reason": "Contradicted on page 3"
    }}
  ],
  "limitations": [
    "Known limitation of this guide"
  ],
  "confidence_level": "high | medium | low",
  "rejection_reason": null
}}
```

PAYLOAD REQUIREMENTS (Phase 3.3):
Each stable_rule MUST include a "payload" object if the rule can be machine-executed.
You MUST generate at least these 3 payload types when applicable:

1. token_detector for room_name:
   {{
     "kind": "token_detector",
     "token_type": "room_name",
     "detector": "regex",
     "pattern": "[A-Z]{{2,}}",
     "min_len": 2
   }}

2. token_detector for room_number:
   {{
     "kind": "token_detector",
     "token_type": "room_number",
     "detector": "regex",
     "pattern": "\\d{{2,4}}",
     "must_be_boxed": false
   }}

3. pairing (associates room_name with room_number):
   {{
     "kind": "pairing",
     "name_token": "room_name",
     "number_token": "room_number",
     "relation": "below",
     "max_distance_px": 100
   }}

Optional - exclude (to filter out global annotations):
   {{
     "kind": "exclude",
     "pattern": "^(PLAN|PAGE|REV|DATE|SCALE).*",
     "detector": "regex"
   }}

CRITICAL RULES:
1. If stable rules ratio < {min_stable_ratio}%, set guide_generated=false
2. If guide_generated=false, stable_rules MUST be empty and rejection_reason MUST explain why
3. ONLY include rules marked as STABLE in stable_rules
4. NEVER include unstable or contradicted rules in stable_rules
5. All excluded rules must have a clear reason
6. Be explicit about limitations
7. Each stable_rule SHOULD have a payload if the rule describes detectable patterns

REFUSAL CASE:
If you cannot generate a guide, respond with:
```json
{{
  "guide_generated": false,
  "stable_rules": [],
  "partial_observations": [...],
  "excluded_rules": [...],
  "limitations": [],
  "confidence_level": "low",
  "rejection_reason": "Specific explanation of why guide cannot be generated and what is needed"
}}
```

Respond ONLY with the JSON object, no other text.
